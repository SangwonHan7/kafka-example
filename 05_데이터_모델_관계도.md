# Saga íŒ¨í„´ - ë°ì´í„° ëª¨ë¸ ê´€ê³„ë„ (ERD)

## ê°œìš”
ì£¼ë¬¸-ê²°ì œ ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš©í•˜ëŠ” ë°ì´í„° ëª¨ë¸ê³¼ í…Œì´ë¸” ê°„ì˜ ê´€ê³„ë¥¼ ë³´ì—¬ì£¼ëŠ” ERD(Entity Relationship Diagram)ìž…ë‹ˆë‹¤.

## ë°ì´í„° ëª¨ë¸ ì„¤ê³„ ì›ì¹™
- **ì„œë¹„ìŠ¤ë³„ ë…ë¦½ ë°ì´í„°ë² ì´ìŠ¤**: ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ê°€ ë…ë¦½ì ì¸ ë°ì´í„°ë² ì´ìŠ¤ ìš´ì˜
- **ì´ë²¤íŠ¸ ì†Œì‹±**: Saga íŠ¸ëžœìž­ì…˜ì˜ ëª¨ë“  ìƒíƒœ ë³€í™” ê¸°ë¡
- **ìµœì¢… ì¼ê´€ì„±**: ë¶„ì‚° í™˜ê²½ì—ì„œì˜ ë°ì´í„° ì¼ê´€ì„± ë³´ìž¥
- **ê°ì‚¬ ì¶”ì **: ëª¨ë“  ì¤‘ìš” ë³€ê²½ ì‚¬í•­ì— ëŒ€í•œ ì¶”ì  ê°€ëŠ¥ì„±

```mermaid
erDiagram
    SAGA_TRANSACTIONS {
        bigint id PK
        string saga_id UK "ê³ ìœ  Saga ì‹ë³„ìž"
        string order_id "ì£¼ë¬¸ ID"
        decimal amount "ê¸ˆì•¡"
        string current_step "í˜„ìž¬ ë‹¨ê³„"
        string status "ìƒíƒœ"
        string last_message "ë§ˆì§€ë§‰ ë©”ì‹œì§€"
        datetime started_at "ì‹œìž‘ ì‹œê°„"
        datetime updated_at "ìˆ˜ì • ì‹œê°„"
        datetime finished_at "ì™„ë£Œ ì‹œê°„"
    }
    
    ORDERS {
        bigint id PK
        string order_id UK "ì£¼ë¬¸ ID"
        decimal amount "ì£¼ë¬¸ ê¸ˆì•¡"
        string status "ì£¼ë¬¸ ìƒíƒœ"
        string failure_reason "ì‹¤íŒ¨ ì‚¬ìœ "
        string saga_id FK "Saga ID"
        datetime created_at "ìƒì„± ì‹œê°„"
    }
    
    PAYMENTS {
        bigint id PK
        string payment_id UK "ê²°ì œ ID"
        string order_id "ì£¼ë¬¸ ID"
        decimal amount "ê²°ì œ ê¸ˆì•¡"
        string currency "í†µí™”"
        string payment_method "ê²°ì œ ìˆ˜ë‹¨"
        string status "ê²°ì œ ìƒíƒœ"
        string failure_reason "ì‹¤íŒ¨ ì‚¬ìœ "
        string saga_id FK "Saga ID"
        datetime created_at "ìƒì„± ì‹œê°„"
        datetime updated_at "ìˆ˜ì • ì‹œê°„"
    }
    
    SAGA_TRANSACTIONS ||--|| ORDERS : "ê´€ë¦¬"
    SAGA_TRANSACTIONS ||--o| PAYMENTS : "ì¶”ì "
    ORDERS ||--o| PAYMENTS : "ê²°ì œ"
```

## í…Œì´ë¸” ìƒì„¸ ì„¤ëª…

### ðŸ”„ SAGA_TRANSACTIONS (Saga íŠ¸ëžœìž­ì…˜)
**ìœ„ì¹˜**: ì£¼ë¬¸ ì„œë¹„ìŠ¤ ë°ì´í„°ë² ì´ìŠ¤
**ì—­í• **: ë¶„ì‚° íŠ¸ëžœìž­ì…˜ì˜ ì „ì²´ ìƒëª…ì£¼ê¸° ê´€ë¦¬

#### í•„ë“œ ì„¤ëª…
- **id**: ê¸°ë³¸ í‚¤ (auto increment)
- **saga_id**: ì „ì—­ ê³ ìœ  ì‹ë³„ìž (UUID)
- **order_id**: ì—°ê´€ëœ ì£¼ë¬¸ ID
- **amount**: íŠ¸ëžœìž­ì…˜ ê¸ˆì•¡
- **current_step**: í˜„ìž¬ ì²˜ë¦¬ ë‹¨ê³„
  - `STARTED`, `ORDER_CREATED`, `PAYMENT_REQUESTED`, `COMPLETED`, `COMPENSATED`, `TIMEOUT`, `COMPENSATION_FAILED`
- **status**: ì „ì²´ ìƒíƒœ
  - `IN_PROGRESS`: ì²˜ë¦¬ ì¤‘
  - `FINISHED`: ì™„ë£Œ (ì„±ê³µ/ì‹¤íŒ¨ ë¬´ê´€)
- **last_message**: ë§ˆì§€ë§‰ ìƒíƒœ ë©”ì‹œì§€
- **started_at**: íŠ¸ëžœìž­ì…˜ ì‹œìž‘ ì‹œê°„
- **updated_at**: ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
- **finished_at**: ì™„ë£Œ ì‹œê°„

#### ì¸ë±ìŠ¤ ì„¤ì •
```sql
CREATE INDEX idx_saga_transactions_saga_id ON saga_transactions(saga_id);
CREATE INDEX idx_saga_transactions_order_id ON saga_transactions(order_id);
CREATE INDEX idx_saga_transactions_status ON saga_transactions(status);
CREATE INDEX idx_saga_transactions_started_at ON saga_transactions(started_at);
```

### ðŸ›’ ORDERS (ì£¼ë¬¸)
**ìœ„ì¹˜**: ì£¼ë¬¸ ì„œë¹„ìŠ¤ ë°ì´í„°ë² ì´ìŠ¤
**ì—­í• **: ì£¼ë¬¸ ì •ë³´ ê´€ë¦¬

#### í•„ë“œ ì„¤ëª…
- **id**: ê¸°ë³¸ í‚¤ (auto increment)
- **order_id**: ì£¼ë¬¸ ê³ ìœ  ì‹ë³„ìž
- **amount**: ì£¼ë¬¸ ê¸ˆì•¡
- **status**: ì£¼ë¬¸ ìƒíƒœ
  - `PENDING`: ì²˜ë¦¬ ì¤‘
  - `COMPLETED`: ì™„ë£Œ
  - `CANCELLED`: ì·¨ì†Œ
- **failure_reason**: ì‹¤íŒ¨ ì‚¬ìœ  (ì‹¤íŒ¨ ì‹œì—ë§Œ)
- **saga_id**: ì—°ê´€ëœ Saga íŠ¸ëžœìž­ì…˜ ID
- **created_at**: ì£¼ë¬¸ ìƒì„± ì‹œê°„

#### ì¸ë±ìŠ¤ ì„¤ì •
```sql
CREATE INDEX idx_orders_order_id ON orders(order_id);
CREATE INDEX idx_orders_saga_id ON orders(saga_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
```

### ðŸ’³ PAYMENTS (ê²°ì œ)
**ìœ„ì¹˜**: ê²°ì œ ì„œë¹„ìŠ¤ ë°ì´í„°ë² ì´ìŠ¤
**ì—­í• **: ê²°ì œ ì •ë³´ ê´€ë¦¬

#### í•„ë“œ ì„¤ëª…
- **id**: ê¸°ë³¸ í‚¤ (auto increment)
- **payment_id**: ê²°ì œ ê³ ìœ  ì‹ë³„ìž
- **order_id**: ì—°ê´€ëœ ì£¼ë¬¸ ID
- **amount**: ê²°ì œ ê¸ˆì•¡
- **currency**: í†µí™” ì½”ë“œ (KRW, USD ë“±)
- **payment_method**: ê²°ì œ ìˆ˜ë‹¨
  - `CARD`: ì‹ ìš©ì¹´ë“œ
  - `BANK_TRANSFER`: ê³„ì¢Œì´ì²´
  - `MOBILE`: ëª¨ë°”ì¼ ê²°ì œ
- **status**: ê²°ì œ ìƒíƒœ
  - `PENDING`: ì²˜ë¦¬ ì¤‘
  - `COMPLETED`: ì™„ë£Œ
  - `FAILED`: ì‹¤íŒ¨
  - `CANCELLED`: ì·¨ì†Œ
- **failure_reason**: ì‹¤íŒ¨ ì‚¬ìœ  (ì‹¤íŒ¨ ì‹œì—ë§Œ)
- **saga_id**: ì—°ê´€ëœ Saga íŠ¸ëžœìž­ì…˜ ID
- **created_at**: ê²°ì œ ìƒì„± ì‹œê°„
- **updated_at**: ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„

#### ì¸ë±ìŠ¤ ì„¤ì •
```sql
CREATE INDEX idx_payments_payment_id ON payments(payment_id);
CREATE INDEX idx_payments_order_id ON payments(order_id);
CREATE INDEX idx_payments_saga_id ON payments(saga_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_created_at ON payments(created_at);
```

## í…Œì´ë¸” ê´€ê³„ ì„¤ëª…

### 1:1 ê´€ê³„ (SAGA_TRANSACTIONS â†” ORDERS)
- í•˜ë‚˜ì˜ Saga íŠ¸ëžœìž­ì…˜ì€ ì •í™•ížˆ í•˜ë‚˜ì˜ ì£¼ë¬¸ì„ ê´€ë¦¬
- í•˜ë‚˜ì˜ ì£¼ë¬¸ì€ í•˜ë‚˜ì˜ Saga íŠ¸ëžœìž­ì…˜ì— ì˜í•´ ê´€ë¦¬ë¨

### 1:N ê´€ê³„ (SAGA_TRANSACTIONS â†” PAYMENTS)
- í•˜ë‚˜ì˜ Saga íŠ¸ëžœìž­ì…˜ì€ ì—¬ëŸ¬ ë²ˆì˜ ê²°ì œ ì‹œë„ë¥¼ ê°€ì§ˆ ìˆ˜ ìžˆìŒ
- ìž¬ì‹œë„ ë˜ëŠ” ë¶€ë¶„ ê²°ì œ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ë°œìƒ

### 1:N ê´€ê³„ (ORDERS â†” PAYMENTS)
- í•˜ë‚˜ì˜ ì£¼ë¬¸ì€ ì—¬ëŸ¬ ë²ˆì˜ ê²°ì œ ì‹œë„ë¥¼ ê°€ì§ˆ ìˆ˜ ìžˆìŒ
- ê²°ì œ ì‹¤íŒ¨ í›„ ìž¬ì‹œë„ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ë°œìƒ

## DDL ìŠ¤í¬ë¦½íŠ¸

### ì£¼ë¬¸ ì„œë¹„ìŠ¤ DB
```sql
-- Saga íŠ¸ëžœìž­ì…˜ í…Œì´ë¸”
CREATE TABLE saga_transactions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    saga_id VARCHAR(255) UNIQUE NOT NULL,
    order_id VARCHAR(255),
    amount DECIMAL(15,2),
    current_step VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL,
    last_message TEXT,
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    finished_at TIMESTAMP NULL,
    
    INDEX idx_saga_transactions_saga_id (saga_id),
    INDEX idx_saga_transactions_order_id (order_id),
    INDEX idx_saga_transactions_status (status),
    INDEX idx_saga_transactions_started_at (started_at)
);

-- ì£¼ë¬¸ í…Œì´ë¸”
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_id VARCHAR(255) UNIQUE NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    status VARCHAR(20) NOT NULL,
    failure_reason TEXT,
    saga_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_orders_order_id (order_id),
    INDEX idx_orders_saga_id (saga_id),
    INDEX idx_orders_status (status),
    INDEX idx_orders_created_at (created_at),
    
    FOREIGN KEY (saga_id) REFERENCES saga_transactions(saga_id)
);
```

### ê²°ì œ ì„œë¹„ìŠ¤ DB
```sql
-- ê²°ì œ í…Œì´ë¸”
CREATE TABLE payments (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    payment_id VARCHAR(255) UNIQUE NOT NULL,
    order_id VARCHAR(255) NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'KRW',
    payment_method VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    failure_reason TEXT,
    saga_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_payments_payment_id (payment_id),
    INDEX idx_payments_order_id (order_id),
    INDEX idx_payments_saga_id (saga_id),
    INDEX idx_payments_status (status),
    INDEX idx_payments_created_at (created_at)
);
```

## ë°ì´í„° ì¼ê´€ì„± ì „ëžµ

### 1. ë³´ìƒ íŠ¸ëžœìž­ì…˜ (Compensating Transaction)
- ê° ì„œë¹„ìŠ¤ëŠ” ìžì‹ ì˜ ë°ì´í„°ë¥¼ ë¡¤ë°±í•  ìˆ˜ ìžˆëŠ” ë³´ìƒ ë¡œì§ êµ¬í˜„
- ì˜ˆ: ì£¼ë¬¸ ì·¨ì†Œ, ê²°ì œ ì·¨ì†Œ

### 2. ë©±ë“±ì„± (Idempotency)
- ë™ì¼í•œ ìš”ì²­ì´ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰ë˜ì–´ë„ ê²°ê³¼ê°€ ë™ì¼
- ì¤‘ë³µ ë©”ì‹œì§€ ì²˜ë¦¬ ë°©ì§€

### 3. ì´ë²¤íŠ¸ ìˆœì„œ ë³´ìž¥
- Kafka íŒŒí‹°ì…”ë‹ì„ í†µí•œ ë©”ì‹œì§€ ìˆœì„œ ë³´ìž¥
- ë™ì¼í•œ ì£¼ë¬¸ IDëŠ” ë™ì¼í•œ íŒŒí‹°ì…˜ìœ¼ë¡œ ì „ì†¡

### 4. íƒ€ìž„ì•„ì›ƒ ì²˜ë¦¬
- ê° ë‹¨ê³„ë³„ íƒ€ìž„ì•„ì›ƒ ì„¤ì •
- ìž¥ì‹œê°„ ì‘ë‹µ ì—†ëŠ” íŠ¸ëžœìž­ì…˜ ìžë™ ì •ë¦¬

## ëª¨ë‹ˆí„°ë§ ì¿¼ë¦¬

### ì§„í–‰ ì¤‘ì¸ Saga ì¡°íšŒ
```sql
SELECT saga_id, order_id, current_step, 
       TIMESTAMPDIFF(MINUTE, started_at, NOW()) as elapsed_minutes
FROM saga_transactions 
WHERE status = 'IN_PROGRESS'
ORDER BY started_at DESC;
```

### íƒ€ìž„ì•„ì›ƒ í›„ë³´ ì¡°íšŒ
```sql
SELECT saga_id, order_id, current_step, started_at
FROM saga_transactions 
WHERE status = 'IN_PROGRESS' 
  AND TIMESTAMPDIFF(MINUTE, started_at, NOW()) > 30
ORDER BY started_at ASC;
```

### ì„±ê³µë¥  í†µê³„
```sql
SELECT 
    DATE(started_at) as date,
    COUNT(*) as total_sagas,
    SUM(CASE WHEN current_step = 'COMPLETED' THEN 1 ELSE 0 END) as completed,
    SUM(CASE WHEN current_step = 'COMPENSATED' THEN 1 ELSE 0 END) as compensated,
    ROUND(SUM(CASE WHEN current_step = 'COMPLETED' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as success_rate
FROM saga_transactions 
WHERE status = 'FINISHED'
  AND started_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(started_at)
ORDER BY date DESC;
``` 