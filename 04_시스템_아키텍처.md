# Saga íŒ¨í„´ - ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

## ê°œìš”
ì£¼ë¬¸-ê²°ì œ ì‹œìŠ¤í…œì˜ ì „ì²´ ì•„í‚¤í…ì²˜ì™€ ê° ì»´í¬ë„ŒíŠ¸ ê°„ì˜ ê´€ê³„ë¥¼ ë³´ì—¬ì£¼ëŠ” ë‹¤ì´ì–´ê·¸ë¨ì…ë‹ˆë‹¤.

## ì•„í‚¤í…ì²˜ íŠ¹ì§•
- **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜**: ì„œë¹„ìŠ¤ë³„ ë…ë¦½ì  ë°°í¬ ë° í™•ì¥
- **ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜**: Kafkaë¥¼ í†µí•œ ë¹„ë™ê¸° ë©”ì‹œì§€ ì²˜ë¦¬
- **ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ íŒ¨í„´**: ì¤‘ì•™ ì§‘ì¤‘ì‹ Saga ê´€ë¦¬
- **í´ë¦¬ê¸€ë í¼ì‹œìŠ¤í„´ìŠ¤**: ì„œë¹„ìŠ¤ë³„ ë…ë¦½ì  ë°ì´í„° ì €ì¥ì†Œ

```mermaid
graph TB
    subgraph "í´ë¼ì´ì–¸íŠ¸ ë ˆì´ì–´"
        Client["ì›¹/ëª¨ë°”ì¼ í´ë¼ì´ì–¸íŠ¸"]
    end
    
    subgraph "API ê²Œì´íŠ¸ì›¨ì´ ë ˆì´ì–´"
        Gateway["API Gateway<br/>(ì„ íƒì‚¬í•­)"]
    end
    
    subgraph "ì£¼ë¬¸ ì„œë¹„ìŠ¤ (Order Service)"
        OC["OrderController<br/>REST API"]
        SC["SagaController<br/>Saga ê´€ë¦¬ API"]
        OS["OrderService<br/>ì£¼ë¬¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§"]
        SOrc["SagaOrchestratorService<br/>Saga ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜"]
        SMS["SagaMonitoringService<br/>ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬"]
        OKL["SagaPaymentResultListener<br/>Kafka ë¦¬ìŠ¤ë„ˆ"]
    end
    
    subgraph "ê²°ì œ ì„œë¹„ìŠ¤ (Payment Service)"
        PS["PaymentService<br/>ê²°ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§"]
        PKL["SagaOrderRequestListener<br/>Kafka ë¦¬ìŠ¤ë„ˆ"]
    end
    
    subgraph "ë©”ì‹œì§€ ë¸Œë¡œì»¤"
        K["Apache Kafka"]
        KT1["payment.request<br/>í† í”½"]
        KT2["payment.result<br/>í† í”½"]
    end
    
    subgraph "ë°ì´í„° ì €ì¥ì†Œ"
        ODB["ì£¼ë¬¸ DB<br/>(H2/MySQL)"]
        PDB["ê²°ì œ DB<br/>(H2/MySQL)"]
        SDB["Saga DB<br/>(H2/MySQL)"]
    end
    
    subgraph "ì™¸ë¶€ ì‹œìŠ¤í…œ"
        PG["ê²°ì œ ê²Œì´íŠ¸ì›¨ì´<br/>(ì™¸ë¶€ API)"]
    end
    
    %% í´ë¼ì´ì–¸íŠ¸ ì—°ê²°
    Client --> Gateway
    Gateway --> OC
    Gateway --> SC
    
    %% ì£¼ë¬¸ ì„œë¹„ìŠ¤ ë‚´ë¶€ ì—°ê²°
    OC --> OS
    SC --> SMS
    OS --> SOrc
    SOrc --> OKL
    
    %% ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
    OS --> ODB
    SOrc --> SDB
    SMS --> SDB
    PS --> PDB
    
    %% Kafka ì—°ê²°
    SOrc --> KT1
    KT1 --> PKL
    PKL --> PS
    PS --> KT2
    KT2 --> OKL
    
    %% ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ê²°
    PS --> PG
    
    %% ëª¨ë‹ˆí„°ë§ ì—°ê²°
    SMS -.-> SOrc
    SMS -.-> K
    
    classDef client fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef api fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef service fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef kafka fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef database fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef external fill:#f9fbe7,stroke:#689f38,stroke-width:2px
    
    class Client client
    class Gateway api
    class OC,SC,OS,SOrc,SMS,OKL,PS,PKL service
    class K,KT1,KT2 kafka
    class ODB,PDB,SDB database
    class PG external
```

## ì»´í¬ë„ŒíŠ¸ ìƒì„¸ ì„¤ëª…

### ğŸŒ í´ë¼ì´ì–¸íŠ¸ ë ˆì´ì–´
- **ì›¹/ëª¨ë°”ì¼ í´ë¼ì´ì–¸íŠ¸**: ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤
- **API ê²Œì´íŠ¸ì›¨ì´**: ë¼ìš°íŒ…, ì¸ì¦, ë¡œë“œë°¸ëŸ°ì‹± (ì„ íƒì‚¬í•­)

### ğŸª ì£¼ë¬¸ ì„œë¹„ìŠ¤ (Order Service)
**í•µì‹¬ ì—­í• **: Saga ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ë° ì£¼ë¬¸ ê´€ë¦¬

#### REST API ê³„ì¸µ
- **OrderController**: ì¼ë°˜ ì£¼ë¬¸ API ì—”ë“œí¬ì¸íŠ¸
- **SagaController**: Saga ê´€ë¦¬ API ì—”ë“œí¬ì¸íŠ¸

#### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê³„ì¸µ
- **OrderService**: ì£¼ë¬¸ ìƒì„± ë° ê´€ë¦¬ ë¡œì§
- **SagaOrchestratorService**: ë¶„ì‚° íŠ¸ëœì­ì…˜ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
- **SagaMonitoringService**: Saga ìƒíƒœ ëª¨ë‹ˆí„°ë§ ë° íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬

#### ë©”ì‹œì§€ ì²˜ë¦¬ ê³„ì¸µ
- **SagaPaymentResultListener**: ê²°ì œ ê²°ê³¼ ìˆ˜ì‹  ë° ì²˜ë¦¬

### ğŸ’³ ê²°ì œ ì„œë¹„ìŠ¤ (Payment Service)
**í•µì‹¬ ì—­í• **: ê²°ì œ ì²˜ë¦¬ ë° ì™¸ë¶€ ê²Œì´íŠ¸ì›¨ì´ ì—°ë™

#### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê³„ì¸µ
- **PaymentService**: ê²°ì œ ì²˜ë¦¬ ë¡œì§ ë° ì™¸ë¶€ API í˜¸ì¶œ

#### ë©”ì‹œì§€ ì²˜ë¦¬ ê³„ì¸µ
- **SagaOrderRequestListener**: ì£¼ë¬¸ ê²°ì œ ìš”ì²­ ìˆ˜ì‹  ë° ì²˜ë¦¬

### ğŸ“¨ ë©”ì‹œì§€ ë¸Œë¡œì»¤ (Apache Kafka)
**í•µì‹¬ ì—­í• **: ì„œë¹„ìŠ¤ ê°„ ë¹„ë™ê¸° í†µì‹ 

#### í† í”½ êµ¬ì¡°
- **payment.request**: ì£¼ë¬¸ ì„œë¹„ìŠ¤ â†’ ê²°ì œ ì„œë¹„ìŠ¤
- **payment.result**: ê²°ì œ ì„œë¹„ìŠ¤ â†’ ì£¼ë¬¸ ì„œë¹„ìŠ¤

### ğŸ—„ï¸ ë°ì´í„° ì €ì¥ì†Œ
**í•µì‹¬ ì—­í• **: ê° ì„œë¹„ìŠ¤ë³„ ë…ë¦½ì  ë°ì´í„° ê´€ë¦¬

- **ì£¼ë¬¸ DB**: ì£¼ë¬¸ ì •ë³´ ì €ì¥
- **ê²°ì œ DB**: ê²°ì œ ì •ë³´ ì €ì¥
- **Saga DB**: Saga íŠ¸ëœì­ì…˜ ìƒíƒœ ì €ì¥

### ğŸ”— ì™¸ë¶€ ì‹œìŠ¤í…œ
- **ê²°ì œ ê²Œì´íŠ¸ì›¨ì´**: ì‹¤ì œ ê²°ì œ ì²˜ë¦¬ (PGì‚¬ API)

## ë°°í¬ êµ¬ì¡°

### ê°œë°œ í™˜ê²½
```yaml
version: '3.8'
services:
  order-service:
    image: order-service:latest
    ports:
      - "8080:8080"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - DB_URL=jdbc:h2:mem:orderdb
    depends_on:
      - kafka
      - order-db
      
  payment-service:
    image: payment-service:latest
    ports:
      - "8081:8080"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - DB_URL=jdbc:h2:mem:paymentdb
    depends_on:
      - kafka
      - payment-db
      
  kafka:
    image: confluentinc/cp-kafka:latest
    ports:
      - "9092:9092"
    environment:
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    ports:
      - "2181:2181"
    environment:
      - ZOOKEEPER_CLIENT_PORT=2181
```

### í”„ë¡œë•ì…˜ í™˜ê²½ ê³ ë ¤ì‚¬í•­

#### ê³ ê°€ìš©ì„± (High Availability)
- **ì„œë¹„ìŠ¤ ì´ì¤‘í™”**: ê° ì„œë¹„ìŠ¤ ìµœì†Œ 2ê°œ ì´ìƒ ì¸ìŠ¤í„´ìŠ¤
- **Kafka í´ëŸ¬ìŠ¤í„°**: 3ê°œ ì´ìƒì˜ ë¸Œë¡œì»¤ êµ¬ì„±
- **ë°ì´í„°ë² ì´ìŠ¤ ë³µì œ**: Master-Slave êµ¬ì„±

#### í™•ì¥ì„± (Scalability)
- **ìˆ˜í‰ í™•ì¥**: ë¡œë“œì— ë”°ë¥¸ ì¸ìŠ¤í„´ìŠ¤ ìë™ ì¦ê°
- **Kafka íŒŒí‹°ì…”ë‹**: ì²˜ë¦¬ëŸ‰ ì¦ëŒ€
- **ë°ì´í„°ë² ì´ìŠ¤ ìƒ¤ë”©**: ë°ì´í„° ë¶„ì‚°

#### ëª¨ë‹ˆí„°ë§ ë° ê´€ì°°ì„±
- **ë¡œê·¸ ìˆ˜ì§‘**: ELK Stack ë˜ëŠ” Fluentd
- **ë©”íŠ¸ë¦­ ëª¨ë‹ˆí„°ë§**: Prometheus + Grafana
- **ë¶„ì‚° ì¶”ì **: Jaeger ë˜ëŠ” Zipkin

## API ì—”ë“œí¬ì¸íŠ¸

### ì£¼ë¬¸ ì„œë¹„ìŠ¤ API
```
POST   /api/orders                    # ì¼ë°˜ ì£¼ë¬¸ ìƒì„±
GET    /api/orders/{orderId}          # ì£¼ë¬¸ ì¡°íšŒ

POST   /api/saga/orders               # Saga ê¸°ë°˜ ì£¼ë¬¸ ìƒì„±
GET    /api/saga/orders/{orderId}/status    # Saga ìƒíƒœ ì¡°íšŒ
GET    /api/saga/transactions/in-progress   # ì§„í–‰ ì¤‘ì¸ Saga ëª©ë¡
POST   /api/saga/transactions/{sagaId}/retry # Saga ì¬ì‹œë„
```

### ê²°ì œ ì„œë¹„ìŠ¤ API
```
POST   /api/payments                  # ì§ì ‘ ê²°ì œ ì²˜ë¦¬ (í…ŒìŠ¤íŠ¸ìš©)
GET    /api/payments/{paymentId}      # ê²°ì œ ì¡°íšŒ
POST   /api/payments/{paymentId}/cancel # ê²°ì œ ì·¨ì†Œ
```

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### ì¸ì¦ ë° ì¸ê°€
- **JWT í† í°**: ì„œë¹„ìŠ¤ ê°„ ì¸ì¦
- **OAuth 2.0**: í´ë¼ì´ì–¸íŠ¸ ì¸ì¦
- **API í‚¤**: ì™¸ë¶€ ê²Œì´íŠ¸ì›¨ì´ ì¸ì¦

### ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ
- **ì„œë¹„ìŠ¤ ë©”ì‹œ (Service Mesh)**: Istio ë˜ëŠ” Linkerd
- **TLS ì•”í˜¸í™”**: ëª¨ë“  í†µì‹  êµ¬ê°„ ì•”í˜¸í™”
- **ë„¤íŠ¸ì›Œí¬ ì •ì±…**: Kubernetes NetworkPolicy

### ë°ì´í„° ë³´ì•ˆ
- **ë°ì´í„° ì•”í˜¸í™”**: ê°œì¸ì •ë³´ í•„ë“œ ì•”í˜¸í™”
- **ê°ì‚¬ ë¡œê·¸**: ì¤‘ìš” ì‘ì—… ì¶”ì 
- **ë°±ì—… ë° ë³µêµ¬**: ì •ê¸°ì  ë°±ì—… ë° ë³µêµ¬ í…ŒìŠ¤íŠ¸ 